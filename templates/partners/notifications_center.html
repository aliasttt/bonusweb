{% extends 'base.html' %}
{% block title %}Notifications{% endblock %}
{% block content %}
{{ business_customers_json|json_script:"business-customers" }}
<div class="max-w-6xl mx-auto px-4 py-12">
  <div class="mb-8">
    <a href="/partners/dashboard/" class="inline-flex items-center px-4 py-2 rounded-md border border-white/20 bg-white/5 hover:bg-white/10 transition text-slate-200 mb-4">← Back to Dashboard</a>
    <h1 class="text-4xl font-bold text-white">Send Push Notification</h1>
    <p class="mt-2 text-slate-400 max-w-3xl">
      Craft a message and deliver it instantly to your customers. Notifications go through Firebase and appear inside the Bonus mobile app and partner web panel.
    </p>
  </div>

  {% if not businesses %}
    <div class="bg-red-500/10 border border-red-500/30 rounded-2xl p-6 text-red-200">
      <h2 class="text-xl font-semibold mb-2">No business found</h2>
      <p class="text-sm text-red-100">You need to register at least one business before sending notifications.</p>
    </div>
  {% else %}
  <div class="grid lg:grid-cols-2 gap-6 mb-10">
    <div class="bg-white/5 rounded-2xl border border-white/10 p-5">
      <p class="text-sm text-slate-400">Business</p>
      <p class="text-2xl font-semibold text-white mt-1">
        {% if default_business_id %}
          {% for biz in businesses %}
            {% if biz.id == default_business_id %}
              {{ biz.name }}
            {% endif %}
          {% endfor %}
        {% else %}
          Not Selected
        {% endif %}
      </p>
      <p class="text-xs text-slate-400 mt-1">Notifications will be sent to customers of this business.</p>
    </div>
    <div class="bg-white/5 rounded-2xl border border-white/10 p-5">
      <p class="text-sm text-slate-400">Delivery</p>
      <p class="text-2xl font-semibold text-white mt-1">Instant</p>
      <p class="text-xs text-slate-400 mt-1">Sent immediately after you hit send.</p>
    </div>
  </div>

  <div class="bg-white/10 border border-white/20 rounded-3xl p-8 shadow-2xl backdrop-blur">
    <form id="notificationForm" class="space-y-6">
      {% csrf_token %}
      <div>
        <label class="block text-sm font-semibold text-slate-200 mb-2">Notification title</label>
        <input type="text" name="title" maxlength="80" required class="w-full px-4 py-3 rounded-xl bg-white text-slate-900 border-2 border-transparent focus:border-primary outline-none transition" placeholder="Doner special discount">
      </div>
      <div>
        <label class="block text-sm font-semibold text-slate-200 mb-2">Message body</label>
        <textarea name="body" rows="4" required class="w-full px-4 py-3 rounded-xl bg-white text-slate-900 border-2 border-transparent focus:border-primary outline-none transition" placeholder="Only today! Grab 20% off on all doners when you show this message."></textarea>
      </div>
      <input type="hidden" name="business_id" id="businessIdInput" value="{{ default_business_id }}">
      <input type="hidden" name="audience" value="business_customers">

      <div id="recipientSection" class="rounded-2xl border border-white/15 bg-white/5 p-5">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h3 class="text-lg font-semibold text-white">Recipients</h3>
            <p class="text-xs text-slate-400">Select individual customers or leave empty to notify all customers of this business.</p>
          </div>
          <div class="flex items-center gap-3">
            <button type="button" id="selectAllBtn" class="px-3 py-1 rounded-lg border border-white/20 text-xs text-white hover:bg-white/10 transition">Select all</button>
            <button type="button" id="clearAllBtn" class="px-3 py-1 rounded-lg border border-white/20 text-xs text-white hover:bg-white/10 transition">Clear</button>
          </div>
        </div>
        <input type="search" id="customerSearch" placeholder="Search by name, email, or phone" class="w-full px-4 py-2 rounded-xl bg-dark-lighter text-white border border-white/10 focus:border-primary outline-none transition mb-4">
        <div id="customerList" class="max-h-64 overflow-y-auto grid md:grid-cols-2 gap-3 text-sm"></div>
        <p class="text-xs text-slate-400 mt-3" id="selectionSummary">No specific recipients selected. All customers of this business will receive this notification.</p>
      </div>

      <div class="flex items-center gap-4">
        <button type="submit" class="px-6 py-3 rounded-2xl bg-gradient-to-r from-primary to-secondary text-white font-semibold shadow-lg shadow-primary/30 hover:shadow-xl transition">
          Send notification
        </button>
        <button type="button" id="previewButton" class="px-6 py-3 rounded-2xl border border-white/30 text-white hover:bg-white/10 transition">
          Preview message
        </button>
      </div>
    </form>

    <div id="statusCard" class="mt-8 hidden rounded-2xl border border-white/10 p-5"></div>
  </div>

  <div class="mt-10 bg-white/5 border border-white/10 rounded-3xl p-8">
    <h2 class="text-2xl font-semibold text-white mb-3">Best practices</h2>
    <ul class="list-disc list-inside text-slate-300 space-y-2 text-sm">
      <li>Send no more than 2 promotions per day per business to avoid user fatigue.</li>
      <li>Keep the title short (under 60 characters) and the body actionable.</li>
      <li>Use the optional JSON data to deep-link users directly to menus, offers, or campaigns.</li>
    </ul>
  </div>
  {% endif %}
</div>

<script>
  const form = document.getElementById("notificationForm");
  const statusCard = document.getElementById("statusCard");
  const businessIdInput = document.getElementById("businessIdInput");
  const customerDataEl = document.getElementById("business-customers");
  const customerSearch = document.getElementById("customerSearch");
  const customerList = document.getElementById("customerList");
  const selectionSummary = document.getElementById("selectionSummary");
  const selectAllBtn = document.getElementById("selectAllBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const previewButton = document.getElementById("previewButton");
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value;
  
  // Parse customers data with error handling
  let customersByBusiness = {};
  if (customerDataEl) {
    try {
      const jsonText = customerDataEl.textContent || "{}";
      console.log("DEBUG: Raw JSON text =", jsonText);
      console.log("DEBUG: JSON text type =", typeof jsonText);
      
      // Try to parse JSON
      const parsed = JSON.parse(jsonText);
      console.log("DEBUG: Parsed data =", parsed);
      console.log("DEBUG: Parsed data type =", typeof parsed);
      
      // Ensure it's an object
      if (typeof parsed === "object" && parsed !== null && !Array.isArray(parsed)) {
        customersByBusiness = parsed;
        
        // Ensure all values are arrays
        for (const key in customersByBusiness) {
          if (!Array.isArray(customersByBusiness[key])) {
            console.warn(`DEBUG: Converting ${key} from ${typeof customersByBusiness[key]} to array`);
            // If it's a string, try to parse it again
            if (typeof customersByBusiness[key] === "string") {
              try {
                customersByBusiness[key] = JSON.parse(customersByBusiness[key]);
              } catch (e) {
                console.error(`DEBUG: Failed to parse ${key} as JSON:`, e);
                customersByBusiness[key] = [];
              }
            } else {
              customersByBusiness[key] = [];
            }
            // Ensure it's still an array after conversion
            if (!Array.isArray(customersByBusiness[key])) {
              customersByBusiness[key] = [];
            }
          }
        }
      } else {
        console.error("DEBUG: Parsed data is not an object!", parsed);
        customersByBusiness = {};
      }
    } catch (error) {
      console.error("DEBUG: Error parsing JSON:", error);
      console.error("DEBUG: JSON text was:", customerDataEl.textContent);
      customersByBusiness = {};
    }
  }
  
  console.log("DEBUG: Final customersByBusiness =", customersByBusiness);
  
  let selectedUserIds = new Set();
  let currentBusinessId = businessIdInput ? parseInt(businessIdInput.value, 10) : (Object.keys(customersByBusiness)[0] || null);

  function getFilteredCustomers() {
    try {
      // Debug: Log current state
      console.log("DEBUG: currentBusinessId =", currentBusinessId);
      console.log("DEBUG: customersByBusiness =", customersByBusiness);
      
      let list = customersByBusiness[currentBusinessId];
      
      // If list is undefined or null, return empty array
      if (list === undefined || list === null) {
        console.log("DEBUG: No customers for business", currentBusinessId);
        return [];
      }
      
      // If list is a string, try to parse it
      if (typeof list === "string") {
        console.warn("DEBUG: List is a string, trying to parse:", list);
        try {
          list = JSON.parse(list);
        } catch (e) {
          console.error("DEBUG: Failed to parse string as JSON:", e);
          return [];
        }
      }
      
      // Ensure list is an array
      if (!Array.isArray(list)) {
        console.error("DEBUG ERROR: customersByBusiness[currentBusinessId] is not an array!", typeof list, list);
        // Try to convert to array if it's an object
        if (typeof list === "object" && list !== null) {
          list = Object.values(list);
        } else {
          return [];
        }
      }
      
      console.log("DEBUG: list length =", list.length);
      
      const searchTerm = (customerSearch?.value || "").trim().toLowerCase();
      if (!searchTerm) {
        return list;
      }
      
      const filtered = list.filter((item) => {
        return (
          item.name?.toLowerCase().includes(searchTerm) ||
          item.email?.toLowerCase().includes(searchTerm) ||
          item.phone?.toLowerCase().includes(searchTerm)
        );
      });
      
      console.log("DEBUG: filtered length =", filtered.length);
      return filtered;
    } catch (error) {
      console.error("DEBUG ERROR in getFilteredCustomers:", error);
      return [];
    }
  }

  function updateSelectionSummary() {
    if (!selectionSummary) return;
    if (!selectedUserIds.size) {
      selectionSummary.textContent = "No specific recipients selected. All customers of this business will receive this notification.";
    } else {
      selectionSummary.textContent = `${selectedUserIds.size} recipient(s) selected.`;
    }
  }

  function renderCustomerList() {
    try {
      console.log("DEBUG: renderCustomerList called");
      
      if (!customerList) {
        console.error("DEBUG ERROR: customerList element not found!");
        return;
      }
      
    customerList.innerHTML = "";
      
      if (!currentBusinessId) {
        console.log("DEBUG: No business ID");
        customerList.innerHTML = `<div class="text-slate-400 text-sm col-span-2">No business selected.</div>`;
        return;
      }
      
      let allCustomers = customersByBusiness[currentBusinessId];
      
      // If undefined or null, set to empty array
      if (allCustomers === undefined || allCustomers === null) {
        allCustomers = [];
      }
      
      // If it's a string, try to parse it
      if (typeof allCustomers === "string") {
        console.warn("DEBUG: allCustomers is a string, trying to parse:", allCustomers);
        try {
          allCustomers = JSON.parse(allCustomers);
        } catch (e) {
          console.error("DEBUG: Failed to parse allCustomers as JSON:", e);
          allCustomers = [];
        }
      }
      
      // Ensure it's an array
      if (!Array.isArray(allCustomers)) {
        console.warn("DEBUG: allCustomers is not an array, converting:", typeof allCustomers, allCustomers);
        // If it's an object, try to convert to array
        if (typeof allCustomers === "object" && allCustomers !== null) {
          allCustomers = Object.values(allCustomers);
        } else {
          allCustomers = [];
        }
      }
      
      console.log("DEBUG: allCustomers =", allCustomers);
      console.log("DEBUG: allCustomers is array?", Array.isArray(allCustomers));
      
      if (!allCustomers.length) {
        console.log("DEBUG: No customers found");
        customerList.innerHTML = `<div class="text-slate-400 text-sm col-span-2">No customers found for this business.</div>`;
        updateSelectionSummary();
        return;
      }
      
    const items = getFilteredCustomers();
      console.log("DEBUG: items =", items);
      console.log("DEBUG: items is array?", Array.isArray(items));
      
      if (!Array.isArray(items)) {
        console.error("DEBUG ERROR: items is not an array!", typeof items, items);
        customerList.innerHTML = `<div class="text-red-400 text-sm col-span-2">Error: Filtered customers is not an array. Check console for details.</div>`;
        return;
      }
      
    if (!items.length) {
        console.log("DEBUG: No items after filter");
      customerList.innerHTML = `<div class="text-slate-400 text-sm col-span-2">No customers found for this filter.</div>`;
        updateSelectionSummary();
      return;
    }
      
      console.log("DEBUG: Rendering", items.length, "items");
    const fragment = document.createDocumentFragment();
    items.forEach((item) => {
      const wrapper = document.createElement("label");
      wrapper.className = "flex items-center gap-3 bg-white/5 rounded-xl px-4 py-3 border border-white/10 hover:border-primary/40 transition cursor-pointer";
      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = item.user_id;
      input.checked = selectedUserIds.has(item.user_id);
      input.className = "w-4 h-4 text-primary focus:ring-primary";
      input.addEventListener("change", () => {
        if (input.checked) {
          selectedUserIds.add(item.user_id);
        } else {
          selectedUserIds.delete(item.user_id);
        }
        updateSelectionSummary();
      });
      const info = document.createElement("div");
      info.className = "flex-1 min-w-0";
      info.innerHTML = `
        <div class="font-semibold text-white truncate">${item.name || "Unknown user"}</div>
        <div class="text-xs text-slate-400 truncate">${item.email || "No email"}${item.phone ? " • " + item.phone : ""}</div>
      `;
      wrapper.appendChild(input);
      wrapper.appendChild(info);
      fragment.appendChild(wrapper);
    });
    customerList.appendChild(fragment);
    updateSelectionSummary();
      console.log("DEBUG: renderCustomerList completed successfully");
    } catch (error) {
      console.error("DEBUG ERROR in renderCustomerList:", error);
      if (customerList) {
        customerList.innerHTML = `<div class="text-red-400 text-sm col-span-2">Error rendering customers: ${error.message}. Check console for details.</div>`;
      }
    }
  }

  // Debug: Log initial state
  console.log("DEBUG: Initial state");
  console.log("DEBUG: businessIdInput =", businessIdInput);
  console.log("DEBUG: businessIdInput value =", businessIdInput?.value);
  console.log("DEBUG: customerDataEl =", customerDataEl);
  console.log("DEBUG: customersByBusiness =", customersByBusiness);
  console.log("DEBUG: currentBusinessId =", currentBusinessId);
  console.log("DEBUG: selectAllBtn =", selectAllBtn);
  console.log("DEBUG: clearAllBtn =", clearAllBtn);
  console.log("DEBUG: previewButton =", previewButton);

  // Initialize customer list on page load
  if (currentBusinessId) {
    renderCustomerList();
  } else {
    if (customerList) {
      customerList.innerHTML = `<div class="text-slate-400 text-sm col-span-2">No business selected. Please select a business first.</div>`;
    }
  }

  if (customerSearch) {
    customerSearch.addEventListener("input", () => {
      console.log("DEBUG: Search input changed");
      renderCustomerList();
    });
  } else {
    console.error("DEBUG ERROR: customerSearch element not found!");
  }

  if (selectAllBtn) {
    selectAllBtn.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("DEBUG: Select all button clicked");
      try {
        const customers = getFilteredCustomers();
        console.log("DEBUG: customers to select =", customers);
        if (Array.isArray(customers)) {
          customers.forEach((item) => {
            if (item && item.user_id) {
              selectedUserIds.add(item.user_id);
            }
          });
          console.log("DEBUG: Selected", selectedUserIds.size, "customers");
      renderCustomerList();
        } else {
          console.error("DEBUG ERROR: customers is not an array!", customers);
          alert("Error: Cannot select customers. Check console for details.");
        }
      } catch (error) {
        console.error("DEBUG ERROR in selectAllBtn:", error);
        alert("Error selecting all: " + error.message);
      }
    });
  } else {
    console.error("DEBUG ERROR: selectAllBtn element not found!");
  }

  if (clearAllBtn) {
    clearAllBtn.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("DEBUG: Clear all button clicked");
      selectedUserIds.clear();
      renderCustomerList();
    });
      } else {
    console.error("DEBUG ERROR: clearAllBtn element not found!");
  }


  function showStatus(message, type = "success") {
    if (!statusCard) return;
    statusCard.classList.remove("hidden");
    statusCard.classList.remove("bg-red-500/20", "border-red-500/40", "text-red-100", "bg-green-500/20", "border-green-500/40", "text-green-100");
    if (type === "error") {
      statusCard.classList.add("bg-red-500/20", "border-red-500/40", "text-red-100");
    } else {
      statusCard.classList.add("bg-green-500/20", "border-green-500/40", "text-green-100");
    }
    statusCard.innerHTML = message;
  }

  function buildPayload(formData) {
    const payload = {
      title: formData.get("title")?.trim(),
      body: formData.get("body")?.trim(),
      audience: "business_customers",
    };

    if (!payload.title || !payload.body) {
      throw new Error("Title and body are required.");
    }

    const businessId = formData.get("business_id");
      if (!businessId) {
      throw new Error("Business ID is required.");
      }
      payload.business_id = parseInt(businessId, 10);
    
      if (selectedUserIds.size) {
      payload.user_ids = Array.from(selectedUserIds);
    }

    return payload;
  }

  if (previewButton) {
    console.log("DEBUG: previewButton found, adding event listener");
    previewButton.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("DEBUG: Preview button clicked");
      try {
        if (!form) {
          console.error("DEBUG ERROR: form not found!");
          alert("Error: Form not found. Please refresh the page.");
          return;
        }
        
        const formData = new FormData(form);
        const title = formData.get("title")?.trim();
        const body = formData.get("body")?.trim();
        
        console.log("DEBUG: title =", title);
        console.log("DEBUG: body =", body);
        
        if (!title || !body) {
          showStatus(`<div class="font-semibold text-lg mb-2">Validation error</div><p>Title and body are required.</p>`, "error");
          return;
        }
        
        const allCustomers = customersByBusiness[currentBusinessId] || [];
        const recipientCount = selectedUserIds.size || (Array.isArray(allCustomers) ? allCustomers.length : 0);
        
        console.log("DEBUG: recipientCount =", recipientCount);
        
        showStatus(`
          <div class="font-semibold text-lg mb-2">Preview</div>
          <div class="text-white text-base mb-1 font-semibold">${title}</div>
          <div class="text-slate-100 text-sm mb-3">${body}</div>
          <div class="text-xs text-slate-300 pt-2 border-t border-white/10">
            Will be sent to ${recipientCount} recipient(s)
          </div>
        `, "success");
      } catch (err) {
        console.error("DEBUG ERROR in previewButton:", err);
        showStatus(`<div class="font-semibold text-lg mb-2">Validation error</div><p>${err.message}</p>`, "error");
      }
    });
  } else {
    console.error("DEBUG ERROR: previewButton element not found!");
  }

  if (form) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const submitButton = form.querySelector("button[type='submit']");
      try {
        const payload = buildPayload(new FormData(form));
        submitButton.disabled = true;
        submitButton.textContent = "Sending...";
        showStatus("Sending notification...", "success");

        const response = await fetch("/api/notifications/send/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken || "",
          },
          body: JSON.stringify(payload),
        });

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.detail || data.error || "Failed to send notification.");
        }

        // Success message in English with green color
        showStatus(`
          <div class="font-semibold text-lg mb-2">✅ Notification sent successfully!</div>
          <p class="text-sm text-slate-100">Delivered to <strong>${data.sent || 0}</strong> registered device(s).</p>
        `, "success");
      } catch (err) {
        showStatus(`
          <div class="font-semibold text-lg mb-1">Failed to send</div>
          <p>${err.message}</p>
        `, "error");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Send notification";
      }
    });
  }
</script>
{% endblock %}

