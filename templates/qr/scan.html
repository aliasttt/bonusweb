{% extends "base.html" %}
{% load static %}

{% block title %}QR Code Scanner - In-Person Payment{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        QR Code Scanner for In-Person Payment
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Camera Scanner -->
                    <div class="text-center mb-4">
                        <div id="scanner-container" class="border rounded p-3">
                            <video id="scanner" width="100%" height="300" style="display: none;"></video>
                            <canvas id="canvas" width="300" height="300" style="display: none;"></canvas>
                            <div id="scanner-placeholder" class="d-flex align-items-center justify-content-center" style="height: 300px; background-color: #f8f9fa;">
                                <div class="text-center">
                                    <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Click the button below to start scanning</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Input -->
                    <div class="mb-4">
                        <label for="manual-token" class="form-label">Or enter QR code manually:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="manual-token" placeholder="Enter QR code here">
                            <button class="btn btn-outline-primary" type="button" onclick="processManualToken()">
                                <i class="fas fa-check"></i> Verify
                            </button>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div id="payment-form" style="display: none;">
                        <div class="alert alert-info">
                            <h5>Business Information</h5>
                            <p id="business-info" class="mb-0"></p>
                        </div>
                        
                        <form id="qr-payment-form">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Number of Stamps:</label>
                                <input type="number" class="form-control" id="amount" value="1" min="1" max="10">
                            </div>
                            
                            <div class="mb-3">
                                <label for="business_password" class="form-label">Business Password (Optional):</label>
                                <input type="password" class="form-control" id="business_password" placeholder="Enter business password if required">
                                <small class="form-text text-muted">Only required if the business has set a password for in-person payments.</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="note" class="form-label">Note (Optional):</label>
                                <textarea class="form-control" id="note" rows="2" placeholder="Additional details..."></textarea>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-credit-card me-2"></i>
                                    Confirm Payment & Add Points
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetScanner()">
                                    <i class="fas fa-redo me-2"></i>
                                    Start Over
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Results -->
                    <div id="payment-result" style="display: none;"></div>
                </div>
            </div>

            <!-- Wallet Status -->
            <div class="card mt-4" id="wallet-status" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Your Wallet Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between">
                                <span>Current Points:</span>
                                <strong id="current-points">0</strong>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between">
                                <span>Reward Cost:</span>
                                <strong id="reward-cost">0</strong>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div class="progress-bar" id="points-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-warning" id="redeem-btn" onclick="redeemReward()" style="display: none;">
                            <i class="fas fa-gift me-2"></i>
                            Redeem Reward
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentToken = null;
let currentBusinessId = null;
let scanner = null;

// Initialize scanner
function initScanner() {
    const video = document.getElementById('scanner');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            video.srcObject = stream;
            video.style.display = 'block';
            document.getElementById('scanner-placeholder').style.display = 'none';
            scanner = setInterval(scanQR, 100);
        })
        .catch(err => {
            console.error('Error accessing camera:', err);
            alert('Camera access not available. Please use manual input.');
        });
}

// Scan for QR codes
function scanQR() {
    const video = document.getElementById('scanner');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        // Here you would integrate with a QR code scanning library like jsQR
        // For now, we'll use manual input
    }
}

// Process manual token input
function processManualToken() {
    const token = document.getElementById('manual-token').value.trim();
    if (token) {
        processToken(token);
    } else {
        alert('Please enter QR code');
    }
}

// Process QR token
function processToken(token) {
    currentToken = token;
    
    // Validate QR code
    fetch('/api/qr/validate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ token: token })
    })
    .then(response => response.json())
    .then(data => {
        if (data.valid) {
            currentBusinessId = data.business_id;
            showPaymentForm(data);
        } else {
            if (data.scanned) {
                alert('این QR کد قبلاً اسکن شده است و دیگر قابل استفاده نیست.');
            } else {
                alert('Invalid QR code');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing QR code');
    });
}

// Show payment form
function showPaymentForm(data) {
    document.getElementById('payment-form').style.display = 'block';
    document.getElementById('business-info').textContent = `Business: ${data.business_name || 'Unknown'}`;
    
    // Show/hide password field based on business requirements
    const passwordField = document.getElementById('business_password').closest('.mb-3');
    if (data.requires_password) {
        passwordField.style.display = 'block';
        document.getElementById('business_password').required = true;
    } else {
        passwordField.style.display = 'none';
        document.getElementById('business_password').required = false;
    }
}

// Handle payment form submission
document.getElementById('qr-payment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const amount = document.getElementById('amount').value;
    const note = document.getElementById('note').value;
    const business_password = document.getElementById('business_password').value;
    
    fetch('/api/qr/payment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            token: currentToken,
            amount: parseInt(amount),
            note: note,
            business_password: business_password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPaymentResult(data);
            updateWalletStatus(data);
        } else {
            alert('خطا: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در پردازش پرداخت');
    });
});

// Show payment result
function showPaymentResult(data) {
    const resultDiv = document.getElementById('payment-result');
    resultDiv.style.display = 'block';
    
    let message = `
        <div class="alert alert-success">
            <h5><i class="fas fa-check-circle me-2"></i>Payment Successful!</h5>
            <p>You received ${data.points_awarded || 0} points.</p>
            ${data.reward_earned ? '<p class="text-warning"><strong>Congratulations! You earned a reward!</strong></p>' : ''}
        </div>
    `;
    
    resultDiv.innerHTML = message;
}

// Update wallet status
function updateWalletStatus(data) {
    document.getElementById('wallet-status').style.display = 'block';
    const cost = data.reward_point_cost || 0;
    document.getElementById('current-points').textContent = data.points_balance || 0;
    document.getElementById('reward-cost').textContent = cost;
    
    const progress = cost > 0 ? (data.points_balance / cost) * 100 : 0;
    document.getElementById('points-progress').style.width = progress + '%';
    
    document.getElementById('redeem-btn').style.display = data.reward_earned ? 'block' : 'none';
}

// Redeem reward
function redeemReward() {
    if (confirm('Are you sure you want to redeem the reward?')) {
        fetch('/api/qr/redeem/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                business_id: currentBusinessId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Reward redeemed successfully!');
                updateWalletStatus(data);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error redeeming reward');
        });
    }
}

// Reset scanner
function resetScanner() {
    currentToken = null;
    currentBusinessId = null;
    document.getElementById('payment-form').style.display = 'none';
    document.getElementById('payment-result').style.display = 'none';
    document.getElementById('wallet-status').style.display = 'none';
    document.getElementById('manual-token').value = '';
    document.getElementById('amount').value = '1';
    document.getElementById('note').value = '';
    document.getElementById('business_password').value = '';
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Start scanner when page loads
document.addEventListener('DOMContentLoaded', function() {
    // For now, we'll focus on manual input
    // initScanner();
});
</script>
{% endblock %}
